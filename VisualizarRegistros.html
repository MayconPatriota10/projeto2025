<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visualizar Registros de Ponto</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="VisualizarRegistros.css">
</head>
<body>

<div class="container">
  <div class="row justify-content-center">
    <div class="col-md-10">
      <h3 class="text-center">Registros de Ponto</h3>
      <!-- Campo de pesquisa -->
      <div class="form-group mb-3">
        <label for="filtroPesquisa">Pesquisar por Nome ou CPF:</label>
        <input type="text" class="form-control" id="filtroPesquisa" placeholder="Digite o nome ou CPF" oninput="filtrarRegistros()">
      </div>
      <div id="tabelaRegistros" class="table-responsive">
        <table class="table table-striped table-bordered">
          <thead>
            <tr>
              <th>Nome</th>
              <th>CPF</th>
              <th>Ação</th>
              <th>Data</th>
              <th>Horário</th>
            </tr>
          </thead>
          <tbody id="corpoTabela"></tbody>
        </table>
      </div>
      <div id="mensagem" class="mt-3"></div>
      <a href="index.html" class="btn btn-secondary w-100 mt-3">Voltar</a>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Armazena todos os pontos e mapa de alunos
  let todosPontos = [];
  let alunoMap = {};

  // Função para normalizar texto (remove acentos e converte para minúsculas)
  function normalizarTexto(texto) {
    if (!texto) return '';
    return texto
      .toLowerCase()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '')
      .trim(); // Remove espaços extras
  }

  // Função para verificar se a string contém os caracteres na ordem digitada
  function contemNaOrdem(texto, filtro) {
    if (!filtro) return true; // Se filtro vazio, retorna true
    const textoNormalizado = normalizarTexto(texto);
    const filtroNormalizado = normalizarTexto(filtro);
    let pos = 0;
    for (let char of filtroNormalizado) {
      pos = textoNormalizado.indexOf(char, pos);
      if (pos === -1) return false; // Caractere não encontrado na ordem
      pos++;
    }
    return true;
  }

  // Função para filtrar e agrupar registros
  function filtrarRegistros() {
    // Obtém o texto digitado
    const filtroTexto = document.getElementById('filtroPesquisa').value;
    const corpoTabela = document.getElementById('corpoTabela');
    const mensagem = document.getElementById('mensagem');

    // Normaliza o texto para nomes e remove não-dígitos para CPFs
    const filtroNormalizado = normalizarTexto(filtroTexto);
    const filtroNumeros = filtroTexto.replace(/\D/g, '');

    // Log para depuração
    console.log('Filtro aplicado:', { texto: filtroNormalizado, numeros: filtroNumeros });

    // Limpa a tabela
    corpoTabela.innerHTML = '';

    // Agrupa registros por CPF e data
    const registrosAgrupados = {};
    todosPontos.forEach(ponto => {
      const key = `${ponto.cpf}_${ponto.data}`;
      if (!registrosAgrupados[key]) {
        registrosAgrupados[key] = {
          cpf: ponto.cpf,
          nome: alunoMap[ponto.cpf] || 'Desconhecido',
          data: ponto.data,
          acoes: [],
          horarios: []
        };
      }
      registrosAgrupados[key].acoes.push(ponto.acao.charAt(0).toUpperCase() + ponto.acao.slice(1));
      registrosAgrupados[key].horarios.push(new Date(ponto.timestamp).toLocaleTimeString('pt-BR', { hour12: false }));
    });

    // Converte para array e filtra
    const pontosFiltrados = Object.values(registrosAgrupados).filter(registro => {
      const nomeNormalizado = normalizarTexto(registro.nome);
      const cpfNumeros = registro.cpf.replace(/\D/g, '');
      // Verifica se o nome ou CPF contém o filtro na ordem correta
      const correspondeNome = contemNaOrdem(registro.nome, filtroTexto);
      const correspondeCpf = filtroNumeros ? contemNaOrdem(registro.cpf, filtroNumeros) : false;
      const corresponde = (filtroNormalizado && correspondeNome) || (filtroNumeros && correspondeCpf) || (!filtroTexto);
      console.log('Registro:', {
        nome: registro.nome,
        nomeNormalizado: nomeNormalizado,
        cpf: cpfNumeros,
        filtroTexto: filtroTexto,
        filtroNormalizado: filtroNormalizado,
        correspondeNome: correspondeNome,
        correspondeCpf: correspondeCpf,
        corresponde: corresponde
      });
      return corresponde;
    });

    // Log dos resultados
    console.log('Registros filtrados:', pontosFiltrados.length);

    // Se não houver resultados, exibe mensagem
    if (pontosFiltrados.length === 0 && filtroTexto) {
      mensagem.innerHTML = 
        `<div class="alert alert-info">Nenhum registro encontrado para o critério de pesquisa.</div>`;
      return;
    }

    // Limpa mensagem se houver resultados ou campo vazio
    mensagem.innerHTML = '';

    // Preenche a tabela com os registros filtrados
    pontosFiltrados.forEach(registro => {
      const linha = document.createElement('tr');
      linha.innerHTML = `
        <td>${registro.nome}</td>
        <td>${registro.cpf}</td>
        <td>${registro.acoes.join(', ')}</td>
        <td>${registro.data}</td>
        <td>${registro.horarios.join(', ')}</td>
      `;
      corpoTabela.appendChild(linha);
    });
  }

  // Carrega dados ao iniciar a página
  document.addEventListener('DOMContentLoaded', function() {
    // Carrega alunos e pontos do localStorage
    const alunos = JSON.parse(localStorage.getItem('alunos')) || [];
    todosPontos = JSON.parse(localStorage.getItem('pontos')) || [];

    // Log para verificar dados carregados
    console.log('Alunos carregados:', alunos);
    console.log('Pontos carregados:', todosPontos);

    // Cria mapa de alunos por CPF
    alunos.forEach(aluno => {
      alunoMap[aluno.cpf] = aluno.nome;
    });

    // Exibe todos os registros inicialmente
    filtrarRegistros();
  });
</script>
</body>
</html>